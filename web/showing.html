<html>
<head>
    <title> manual classifier image </title>

    <script type='text/javascript'>
        function load_next_image()
        {
			if (document.getElementById('all_labels').length == 0) {
				get_all_labels();
			}

			clear_selected();

            // 获取下一张图片名字，显示
            req = new XMLHttpRequest();
            req.open('GET', '/retrain/api/next', false);
            req.send();

            res = req.responseText;

            if (res == 'None') {
                document.getElementById('image').innerHTML = "No more images";
            }
            else {
                // json 格式
                j = JSON.parse(res)
                var dt = new Date();
                document.getElementById('img').src = j.url + "?dt=" + dt.getTime();
                document.getElementById('top1').innerHTML = j.pred.top1;
                document.getElementById('top2').innerHTML = j.pred.top2;
                document.getElementById('top3').innerHTML = j.pred.top3;
                document.getElementById('key').innerHTML = j.key;
                document.getElementById('label').innerHTML = j.label;
				document.getElementById('all_labels').childNodes[parseInt(j.label)].setAttribute("selected", "selected");
            }
        }

		function clear_selected()
		{
			// 清除 all_labels 中的 selected 属性
			var all = document.getElementById('all_labels').childNodes;
			for (i = 0; i < all.length; i++) {
				all[i].removeAttribute('selected');
			}
		}

        function confirm_curr()
        {
            // 确认当前分类结果，保存，下一帧 ...
			// 从 all_labels 中选择当前选中的标签 ...
			index = document.getElementById('all_labels').selectedIndex;

            req = new XMLHttpRequest();
            req.open('PUT', '/retrain/api/confirm', false);
            req.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            req.send('{"key":"' + document.getElementById('key').innerHTML + '", "label":"' + index.toString() + '"}');

            load_next_image()
        }

        function undo()
        {
            // 重新标定前一帧 ..
            req = new XMLHttpRequest();
			req.open('PUT', '/retrain/api/cancel', false);
			req.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            req.send()

			load_next_image()
        }

		function get_all_labels()
		{
			// 获取所有分类标签，显示到 all_select 中
			req = new XMLHttpRequest();
			req.open('GET', '/get_labels', false);
			req.send();
			body = req.responseText;

			j = JSON.parse(body);
			labels = j.labels;
			
			for (i = 0; i < labels.length; i++) {
				document.getElementById('all_labels').innerHTML += '<option>' + labels[i] + '</option>';
			}
		}


    </script>
</head>
<body onload='load_next_image()'>
    <div id='image'>
        <img src='' id='img' alt='loading' width='640px' height='360px'>
        </img>

        <p>
        <b>预测类型为：</b>
            <div id='top1'></div> <br>
            <div id='top2'></div> <br>
            <div id='top3'></div> <br>
    </div>


    <hr/>
    <div id='debug' >
        <b>调试信息</b>
       <br> <div id='key'></div> &nbsp; <div id='label'></div>
        <hr/>
    </div>

    <div id='buttons'>
        <input type='button' value='正确，下一张' onclick="confirm_curr()" width="100px" height="40px"/>
		<p> 
		如果自动判断的不合理，请选择正确的分类: <select id='all_labels'></select>
			<input type='button' value='确认, 下一张' onclick="confirm_curr()"/>
		<p>
		撤销上次选择，重新分类:
        <input type='button' value='撤销' onclick="undo()"/>
    </div>

</body>
</html>
