<html>
<head>
    <title> manual classifier image </title>

    <script type='text/javascript'>

        function load_next_image()
        {
			e = document.getElementById('all_labels');
			if (e.options.length == 0) {
				get_all_labels();
			}

			clear_selected(e);

            // 获取下一张图片名字，显示
            req = new XMLHttpRequest();
            req.open('GET', '/retrain/api/next', false);
            req.send();

            res = req.responseText;

            if (res == 'None') {
                document.getElementById('image').innerHTML = "No more images";
                alert("No more images!");
            }
            else {
                // json 格式
                j = JSON.parse(res)
                var dt = new Date();
                document.getElementById('img').src = j.url + "?dt=" + dt.getTime();
                document.getElementById('top1').innerHTML = j.pred.top1;
                document.getElementById('top2').innerHTML = j.pred.top2;
                document.getElementById('top3').innerHTML = j.pred.top3;
                document.getElementById('key').innerHTML = j.key;
                document.getElementById('label').innerHTML = j.label;

                // 找到匹配的 title
                var found = 0;
                for (i = 0; i < e.options.length; i++) {
                    if (e.options[i].text == j.title) {
                        //e.options[i].setAttribute("selected");
                        e.selectedIndex = i;
                        
                        found = 1;
                        break;
                    }
                }

                if (found == 0) {
                    alert('NOT found???')
                }
            }
        }

		function clear_selected(e)
		{
			// 清除 all_labels 中的 selected 属性
            for (i = 0; i < e.options.length; i++) {
                e.options[i].removeAttribute('selected');
            }
		}

        function confirm_curr()
        {
            // 确认当前分类结果，保存，下一帧 ...
			// 从 all_labels 中选择当前选中的标签 ...
			e = document.getElementById('all_labels');
            index = e.selectedIndex;
            title = e.options[index].text;

            selected(title);

            load_next_image();
        }

        function selected(title)
        {
            req = new XMLHttpRequest();
            req.open('PUT', '/retrain/api/confirm', false);
            req.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            req.send('{"key":"' + document.getElementById('key').innerHTML + '", "title":"' + title + '"}');

            document.getElementById('last_selected').innerHTML = title;
        }

        function select_me(n)
        {
            name = 'top' + n.toString();    // 构造 id name
            e = document.getElementById(name);
            title = e.innerHTML;

            // FIXME: title 为空格分隔，前面为 title, 后面为 score，需要扔掉 score
            ss = title.split(" ");
            title = ss[0];

            selected(title);

            load_next_image();
        }

        function undo()
        {
            // 重新标定前一帧 ..
            req = new XMLHttpRequest();
			req.open('PUT', '/retrain/api/cancel', false);
			req.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            req.send();

            document.getElementById('last_selected').innerHTML = "";

			load_next_image();
        }

        function reselect()
        {
            // 重复上次，由服务器决定 ...

            last_title = document.getElementById('last_selected').innerHTML;
            if (last_title.length > 3) {
                selected(last_title);
                load_next_image();
            }
            else {
                alert('NO last title!!!!');
            }
        }

        function skip()
        {
            req = new XMLHttpRequest();
            req.open('PUT', '/retrain/api/skip', false);
            req.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            req.send('{"key":"' + document.getElementById('key').innerHTML + '"}');

            document.getElementById('last_selected').innerHTML = "";

            load_next_image();
        }

		function get_all_labels()
		{
			// 获取所有分类标签，显示到 all_select 中
			req = new XMLHttpRequest();
			req.open('GET', '/get_labels', false);
			req.send();
			body = req.responseText;

			j = JSON.parse(body);
			labels = j.labels;
			
			for (i = 0; i < labels.length; i++) {
				document.getElementById('all_labels').innerHTML += '<option>' + labels[i] + '</option>';
			}
		}


    </script>
</head>
<body onload='load_next_image()'>
    <div id='image'>
        <img src='' id='img' alt='loading' width='640px' height='360px'>
        </img>

        <p>
        <b>预测类型为：</b>
        
        <table border="1">
          <tr>
            <td><div id='top1'>top1</div></td> <td><input type='button' value='对?' onclick="select_me(1)"/></td>
          </tr>
          <tr>
            <td><div id='top2'>top2</div></td> <td><input type='button' value='对?' onclick="select_me(2)"/></td>
          </tr>
          <tr>
            <td><div id='top3'>top2</div></td> <td><input type='button' value='对?' onclick="select_me(3)"/></td>
          </tr>
        </table>
    </div>


    <div id='buttons'>
		如果自动判断的不合理，请选择正确的分类: <select id='all_labels'></select>
			<input type='button' value='确认, 下一张' onclick="confirm_curr()"/>
		<p>
        <table border='1'>
        <tr>
        <td>上次选择为</td><td><b><div id='last_selected'></div></b></td> <td><input type='button' value='重复上次选择' onclick="reselect()"/></td>
        </tr>
        </table>
        <p>
		撤销上次选择，重新分类:
        <input type='button' value='撤销' onclick="undo()"/>
        <p>
        不确认或者垃圾图片：
        <input type='button' value='丢弃' onclick="skip()"/>
    </div>
    <hr/>
    <div id='debug' >
        <b>调试信息</b>
       <br> <div id='key'></div> &nbsp; <div id='label'></div>
        <hr/>
    </div>


</body>
</html>
